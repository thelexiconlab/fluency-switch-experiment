<!DOCTYPE html>
<html>
<head>
    <title>
        jsPsych
    </title>

    <script src="https://unpkg.com/jspsych@7.3.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-select@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.2"></script>
    <link href="https://unpkg.com/jspsych@7.3.0/css/jspsych.css" rel="stylesheet" type="text/css" /> 
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.1"></script>
    <script src="lists.js"></script>
    <script src="practice.js"></script>
</head>
<body>
<script>

const jsPsych = initJsPsych({
            on_finish: function() {
            jsPsych.data.displayData();
            }
            });

var timeline = [];

var Instructions1 = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
  <p style="font-size:20px;"> Welcome! Thank you for your interest in our study. </p>
  <p style="font-size:20px;"> This study is being conducted by researchers at Bowdoin College.</p>
  <p style="font-size:20px;"> In this experiment, you will be asked to judge the relatedness of different words.</p>
  <p style="font-size:20px;"> The entire experiment should not last more than 60 minutes. You will be paid $10 USD for your participation. </p>
  <p style="font-size:20px;"> Please click <a href = "https://drive.google.com/file/d/1nlZ_4ybU8x6dxAch1sgIze4WqATWSxQZ/view?usp=share_link" target = "_blank">here</a> to read the full consent form. </p>
  <p style="font-size:20px;"> If you agree to participate, please click the button below to continue to experiment instructions.</p>
  `,
  choices: ['I agree to participate']
    };

    //timeline.push(Instructions1)
    
    var PracticeInstructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `<p style="font-size:20px;">For this experiment you will be presented with lists of words from a given domain. </p>
        <p style="font-size:20px;"> Each list will have words from one of six possible domains: </p>
        <p style="font-size:20px;"> Cities, Animals, Occupations, Sports, Foods, and Vehicles. </p>
        <p style="font-size:20px;"> Your task will be to judge the relatedness of the words and organize them into groups. </p>
        <p style="font-size:20px;"> You'll indicate the groupings by placing a check at the start of a new group. </p>
        <p style="font-size:20px;"> In order to familiarize youself with this procedure, you will first be presented with six practice lists, one list from each domain. </p>
         <p style="font-size:20px;"> Press Continue when you are ready to begin the practice trial.</p>`,
        choices: ['Continue'],
    };

    //timeline.push(PracticeInstructions )

    var Practice = {
        type: jsPsychSurveyMultiSelect,
        questions: [
          {
            prompt: "Place a check next to each item that starts a new grouping:",
            options: jsPsych.timelineVariable("pr"),
            required: false
          }
    ]
    };
/*
    var timeline_practice = {
      timeline: [Practice],
      timeline_variables: practicelist2,
      randomize_order: true
    }
    */

    //timeline.push(timeline_practice)

    var Instructions2 = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `<p>Thank you for completing these practice lists. You will now move onto the actual experiment </p>
         <p>Please indicate the groupings as well as you can, press Continue when you are ready</p>`,
        choices: ['Continue'],
    };

  //timeline.push(Instructions2)

  var fixation = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: '<p style="font-size: 48px;">+</p> New list about to begin!',
    choices: "NO_KEYS",
    trial_duration: 1000,
    on_finish: function(){
      current_cluster = []
      this_domain_count = 0
    }
};      


var current_cluster = []
var this_domain_count = 0



var buttontrial = {
  type: jsPsychHtmlButtonResponse,
  choices: function(){
   var choice1 =  "Add <span style='color:red'> " + String(jsPsych.timelineVariable("word")).toUpperCase() + " </span>to current group"
   var choice2 =  "Start a new group for <span style='color:red'> " + String(jsPsych.timelineVariable("word")).toUpperCase()
   return [choice1, choice2]
  },
  timeline: [
    {
      stimulus: function() {
        var stimulus_text = "The <b>current group</b> contains: <span style='color:blue'> " + current_cluster.join(", ") + "</span> <br> <p style='color:black'> The next item is: <span style='color:red'>" +  String(jsPsych.timelineVariable("word")).toUpperCase() + "</span> <br> <p> What would you like to do?</p>"
        return stimulus_text
      }
    },
  ],
  on_finish: function(data){
    this_domain_count += 1
    
    if (data.response == 0) {
      current_cluster.push(String(jsPsych.timelineVariable("word")).toUpperCase())
    }
    if (data.response == 1) {
      current_cluster = []
      current_cluster.push(String(jsPsych.timelineVariable("word")).toUpperCase())
    }
    data.cluster = current_cluster.join(", ")
  },
  on_load: function(trial) {
    if (this_domain_count == 0) {
      current_cluster.push(String(jsPsych.timelineVariable("word")).toUpperCase())
      console.log(current_cluster)
      jsPsych.finishTrial()
    }
  }
};


var teststimuli = []
var subjectlist = [1,2,3] // 3 lists

var CONDITION = subjectlist[Math.floor(Math.random() * subjectlist.length)];

//teststimuli = find_list(CONDITION)
teststimuli = list1

var domains = ["ANIMALS", "FOODS", "OCCUPATIONS"]

var shuffledDomains = jsPsych.randomization.shuffle(domains);
console.log("shuffledDomains=",shuffledDomains)

var domain_info = []

// loop through different domains

for (var i = 0; i < shuffledDomains.length; i++) {
    console.log("i=",i)
    var d = shuffledDomains[i]
    domain_info[i] = 'You will now provide groupings for the domain ' + d + '<br><br>'
    

    console.log("d=",d)

   
    var domain_info = {
        type: jsPsychHtmlButtonResponse,
        stimulus: domain_info[i],
        choices: ['Continue'],
        on_finish: function() {
          current_cluster = []
          this_domain_count = 0
        }
    };

    if(i < shuffledDomains.length){
    // reset current_cluster
    current_cluster = []
    timeline.push(domain_info)
    
    }

    // within a given domain, we want to present different subject lists
    // and separate each list with a fixation cross
    // we could first extract the domain list itself for all subjects
    

    domain_list_json = extract_domain_subset(teststimuli, d)
    console.log("domain_list_json:", domain_list_json)

    var sids = Array.from(new Set(domain_list_json.map(({ SIDNO }) => SIDNO)));
    var shuffledIDs = jsPsych.randomization.shuffle(sids);


    // and then loop through different subjects


    // here we extract the individual subject lists for a given domain
    
    for (var j = 0; j < shuffledIDs.length; j++){

      timeline.push(fixation)
      var list_proc = {
          timeline: [buttontrial],
          timeline_variables: extract_subject_subset(domain_list_json, shuffledIDs[j]),
          randomize_order: false
        }

    timeline.push(list_proc)

    }


    }

    

    var demoinstructions = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
    <p> You have completed the experiment portion! </p>
    <p>Before you are done, we would like you to answer some basic demographic questions. </p>
      <p>Note that your answers to these questions will not affect your compensation/credit. </p>
      <p> While some questions are required (*) to obtain some basic information about our recruitment sample <p>
        <p> you can choose to skip other questions that you do not feel comfortable answering. </p>
        <p>Click the button below to continue.</p>
    `,
    choices: ['Continue'],
        data: {
          typeoftrial: 'demo',
        }
    }; 

    timeline.push(demoinstructions)

    var demo_1 = {
        type: jsPsychSurveyText,
        questions: [
          {prompt: 'What is your age?', required: true, name: 'Age'},
          {prompt: 'What is your gender?', required: true, name: 'Gender'},
          {prompt: 'How many years of formal education have you had? (consider graduating high school to be 12 years)', 
          required: true, name: 'Education'}
        ],
        button_label: 'Next',
        data: {
          typeoftrial: 'demo',
          Experiment: jsPsych.timelineVariable('Experiment'),
        }
    };

    var demo_2 = {
  type: jsPsychSurveyMultiSelect,
  questions: [
    {
      prompt: "Please select all the racial categories that apply to you:", 
      options: ["American Indian/Alaskan Native","Asian", "Black/African American", 
      "Native Hawaiian or Other Pacific Islander" , 
       "White/Caucasian", "More than once race", "Other"], 
      horizontal: false,
      required: false,
      name: 'Race'
    }
  ],
  data: {
          typeoftrial: 'demo',
          Experiment: jsPsych.timelineVariable('Experiment'),
        }
};

    var demo_3 = {
      type: jsPsychSurveyMultiChoice,
      questions: [
      {
          prompt: "Are you of Hispanic, Latino/a/x or of Spanish origin?", 
          name: 'Latino', 
          options: ['Yes', 'No', 'Prefer not to respond'], 
          required: false
        }, 
        {
          prompt: "What is your dominant hand?", 
          name: 'DominantHand', 
          options: ['Left', 'Right', 'Ambidexterous'], 
          required: false
        }, 
        {
          prompt: "Please indicate what time of the day you feel most alert:", 
          name: 'Alert', 
          options: ['Morning', 'Afternoon', 'Evening', 'No Differences'], 
          required: false
        },
      ],
        data: {
          typeoftrial: 'demo',
          Experiment: jsPsych.timelineVariable('Experiment'),
        }
    };

  var english = {
      type: jsPsychSurveyMultiChoice,
      questions: [
        {
          prompt: "Is English your first language?", 
          name: 'English', 
          options: ['Yes', 'No'], 
          required: true
        },
      ],
        data: {
          typeoftrial: 'english',
          Experiment: jsPsych.timelineVariable('Experiment'),
        }
    };


var not_english = {
type: jsPsychSurveyText,
preamble: "<p> You indicated that English is not your first language in the previous question. Please answer the following questions:</p> ",
questions: [ {prompt: "What is your first language?"},
{prompt: "At what age did you learn English?"} ],
data: {
          typeoftrial: 'notenglish',
          Experiment: jsPsych.timelineVariable('Experiment'),
        }
}

var not_english_loop = {
timeline: [not_english],
conditional_function: function() {
var dat = jsPsych.data.getLastTrialData().values()[0];
var answer = JSON.stringify(dat.response.English);
answer = answer.replace(/\W/g, '')
if(answer.localeCompare("No") == 0) {return true;} 
else {return false;}
}
}

var demo_5 = {
type: jsPsychSurveyText,
questions: [ {prompt: "Is there anything else we should know about, which might have affected your performance during the experiment? (e.g., lack of sleep, feeling ill etc.)"},
 ],
data: {
          typeoftrial: 'demo',
          Experiment: jsPsych.timelineVariable('Experiment'),
        }
}

	var demo_procedure = {
      timeline: [demo_1, demo_2,demo_3, english, not_english_loop, demo_5]
    }
    
  //timeline.push(demo_procedure)



    var endexperiment = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `<p>Thank you for participating! </p>
        <p> Please click <a href="https://bit.ly/3GHKbaL" target="_blank" rel="noopener noreferrer">here</a> to access the debriefing form and know more about our research.</p>
        <p> Please click the button below to finish the experiment and save your data.</p>
        <p> IMPORTANT: Please do not leave this page without clicking the button below.</p>
          `,
        choices: ['Finish and Save Data']
    };
    
  timeline.push(endexperiment)

  

function find_list(condition_number){
  var stimuli = []
  if(condition_number == 1){
    stimuli = list1
  }
  else if(condition_number == 2){
    stimuli = list2
  }
  
  else {
    stimuli = list3
  }

  return stimuli

}


  function extract_domain_subset(json_list, domain_name){
       
       console.log("domain_name=",domain_name)

      const filtered_domain = json_list.filter(({domain}) => domain === domain_name);
      console.log("filtered_domain=",filtered_domain)
      return filtered_domain
    }

    function extract_subject_subset(json_list, subject_name){
       
       console.log("subject_name=",subject_name)

      const filtered_sub = json_list.filter(({SIDNO}) => SIDNO === subject_name);
      console.log("filtered_json=",filtered_sub)
      return filtered_sub
    }

    
      //timeline.push(demo_procedure);
      //timeline.push(endexperiment);
      
      jsPsych.run(timeline);


      



</script>
</body>

</html>